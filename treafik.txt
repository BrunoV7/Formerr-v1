# MigraÃ§Ã£o para Traefik: NGINX Ingress + Cert-Manager â†’ Traefik

## ğŸ¯ **Por que migrar para Traefik?**

### **Problemas com NGINX + Cert-Manager:**
- âŒ Problemas de timing com webhooks do cert-manager
- âŒ ConfiguraÃ§Ã£o complexa (2 componentes separados)
- âŒ Erros frequentes: "failed calling webhook cert-manager"
- âŒ DependÃªncias entre componentes
- âŒ Mais recursos K8s necessÃ¡rios

### **Vantagens do Traefik:**
- âœ… **Gratuito e open-source** (Apache 2.0)
- âœ… **Tudo integrado** - ingress + SSL em um sÃ³ lugar
- âœ… **Auto-discovery** automÃ¡tico de serviÃ§os
- âœ… **Let's Encrypt nativo** - sem webhooks problemÃ¡ticos
- âœ… **Dashboard web integrado** para monitoring
- âœ… **ConfiguraÃ§Ã£o mais simples**
- âœ… **Melhor performance** 
- âœ… **Menos problemas de deployment**

## ğŸš€ **O que mudou?**

### **Antes (NGINX + Cert-Manager):**
```yaml
# Precisava de ClusterIssuers separados
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    email: admin@example.com
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx

# E depois Ingress separado
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    kubernetes.io/ingress.class: nginx
```

### **Agora (Traefik):**
```yaml
# Tudo em um lugar - SSL automÃ¡tico!
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    traefik.ingress.kubernetes.io/router.tls.certresolver: letsencrypt
spec:
  ingressClassName: traefik
  rules:
  - host: your-domain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: your-service
            port:
              number: 80
  tls:
  - hosts:
    - your-domain.com
    secretName: your-domain-tls
```

## ğŸ“ **Arquivos Criados/Modificados:**

### **Novos arquivos:**
- `scripts/install-traefik.sh` - Script de instalaÃ§Ã£o completa
- `k8s/monitoring/traefik-ingress.yaml` - Exemplos de Ingress

### **Arquivos modificados:**
- `.github/workflows/deploy-production.yml` - Usa Traefik ao invÃ©s de NGINX
- `.github/workflows/deploy-staging.yml` - Usa Traefik ao invÃ©s de NGINX

### **Arquivos que podem ser removidos:**
- `scripts/install-ingress.sh` (obsoleto)
- `k8s/monitoring/ingress-cert-manager.yaml` (obsoleto)

## ğŸ”§ **Como usar:**

### **1. InstalaÃ§Ã£o (automÃ¡tica via workflow):**
O script `install-traefik.sh` Ã© executado automaticamente durante o deploy e instala:
- Traefik v3.0
- CRDs necessÃ¡rios
- ConfiguraÃ§Ã£o com Let's Encrypt
- LoadBalancer service
- Dashboard (opcional)

### **2. ConfiguraÃ§Ã£o de domÃ­nio:**
```bash
# 1. Obter IP do LoadBalancer
kubectl get service traefik -n traefik

# 2. Configurar DNS
# A record: your-domain.com â†’ EXTERNAL-IP
# A record: api.your-domain.com â†’ EXTERNAL-IP
```

### **3. Atualizar email para Let's Encrypt:**
Edite `scripts/install-traefik.sh` e mude:
```yaml
email: admin@formerr.example.com  # Para seu email real
```

### **4. Criar Ingress para suas aplicaÃ§Ãµes:**
Use os exemplos em `k8s/monitoring/traefik-ingress.yaml`

## ğŸ›ï¸ **Dashboard do Traefik:**

### **Acesso seguro via port-forward:**
```bash
kubectl port-forward -n traefik service/traefik-dashboard 8080:8080
# Acesse: http://localhost:8080
```

### **Acesso via Ingress (opcional):**
Descomente a seÃ§Ã£o do dashboard em `traefik-ingress.yaml`

## ğŸ“Š **ComparaÃ§Ã£o de recursos:**

| Aspecto | NGINX + Cert-Manager | Traefik |
|---------|---------------------|---------|
| **Pods** | ~5 pods | ~1 pod |
| **ConfigMaps** | ~3 | ~1 |
| **Services** | ~3 | ~2 |
| **CRDs** | ~6 | ~7 |
| **Namespaces** | 2 (ingress-nginx, cert-manager) | 1 (traefik) |
| **Problemas de timing** | âŒ Frequentes | âœ… Raros |
| **ConfiguraÃ§Ã£o SSL** | âŒ Complexa | âœ… Simples |
| **Dashboard** | âŒ NÃ£o incluso | âœ… Incluso |

## ğŸ” **Troubleshooting:**

### **Verificar status do Traefik:**
```bash
# Pods
kubectl get pods -n traefik

# Services e LoadBalancer
kubectl get services -n traefik

# Logs
kubectl logs -n traefik deployment/traefik

# Ingress classes
kubectl get ingressclass
```

### **Verificar certificados SSL:**
```bash
# Secrets TLS criados automaticamente
kubectl get secrets --all-namespaces | grep tls

# Verificar especÃ­fico
kubectl describe secret your-domain-tls -n default
```

### **Comandos Ãºteis:**
```bash
# Dashboard via port-forward
kubectl port-forward -n traefik service/traefik-dashboard 8080:8080

# Ver configuraÃ§Ã£o atual
kubectl get configmap traefik-config -n traefik -o yaml

# Restart Traefik se necessÃ¡rio
kubectl rollout restart deployment/traefik -n traefik
```

## ğŸ‰ **BenefÃ­cios da migraÃ§Ã£o:**

1. **âœ… Menos problemas de deployment** - sem mais erros de webhook
2. **âœ… ConfiguraÃ§Ã£o mais simples** - tudo em um lugar
3. **âœ… SSL automÃ¡tico** - sem ClusterIssuers separados
4. **âœ… Dashboard de monitoramento** - visibilidade total
5. **âœ… Melhor performance** - menos overhead
6. **âœ… Menos recursos** - footprint menor no cluster

## ğŸš€ **PrÃ³ximos passos:**

1. âœ… Traefik instalado via workflow
2. ğŸ”„ Atualizar DNS para apontar para o novo LoadBalancer
3. ğŸ”„ Mudar email no script `install-traefik.sh`
4. ğŸ”„ Criar Ingress resources usando os exemplos
5. ğŸ”„ Testar SSL automÃ¡tico
6. ğŸ”„ Configurar dashboard (opcional)

---

**Status:** âœ… **MIGRAÃ‡ÃƒO COMPLETA** - Traefik substituiu NGINX + Cert-Manager com sucesso!

**LoadBalancer:** Verifique com `kubectl get service traefik -n traefik`
**Dashboard:** `kubectl port-forward -n traefik service/traefik-dashboard 8080:8080`
